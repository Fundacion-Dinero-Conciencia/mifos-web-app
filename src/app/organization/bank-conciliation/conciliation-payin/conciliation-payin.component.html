<main class="container">
  <form [formGroup]="filters" fxLayout="row wrap" fxLayoutGap="25px" fxLayoutAlign="space-between center">
    <!-- Tipo de cliente -->
    <mat-form-field fxFlex="20%" class="inputSearch m-b-10">
      <mat-label>Tipo de cliente</mat-label>
      <mat-select formControlName="clientTypeId">
        <mat-option *ngFor="let type of clientOptions" [value]="type.id">
          {{ type.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- RUT -->
    <mat-form-field fxFlex="20%" class="inputSearch m-b-10">
      <mat-label>RUT</mat-label>
      <input matInput formControlName="rut" />
    </mat-form-field>

    <!-- Id transacción -->
    <mat-form-field fxFlex="20%" class="inputSearch m-b-10">
      <mat-label>Id transacción</mat-label>
      <input matInput formControlName="notificationId" />
    </mat-form-field>

    <!-- Estado -->
    <mat-form-field fxFlex="20%" class="inputSearch m-b-10">
      <mat-label>Estado</mat-label>
      <mat-select formControlName="status">
        <mat-option *ngFor="let status of statusOptions" [value]="status.id">
          {{ status.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Botones -->
    <div fxFlex="100%" fxLayout="row" fxLayoutAlign="end center" class="m-b-10" fxLayoutGap="10px" class="m-r-20">
      <button mat-raised-button color="primary" class="m-r-10" type="button" (click)="applyFilters()">Buscar</button>
      <button mat-stroked-button color="primary" type="button" (click)="onClear()">Limpiar</button>
    </div>
  </form>
  <table mat-table [dataSource]="dataSource" matSort class="m-t-25 conciliation-table">
    <!-- Fecha Sistema -->
    <ng-container matColumnDef="systemDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha Sistema</th>
      <td mat-cell *matCellDef="let row">
        {{ row.transactionDate | date: 'dd-MM-yyyy' }}
      </td>
    </ng-container>

    <!-- RUT -->
    <ng-container matColumnDef="rut">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>RUT</th>
      <td mat-cell *matCellDef="let row">
        {{ row.rut }}
      </td>
    </ng-container>

    <!-- Tipo de cliente -->
    <ng-container matColumnDef="clientType">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo de cliente</th>
      <td mat-cell *matCellDef="let row">
        {{ row.clientType?.name || 'No encontrado' }}
      </td>
    </ng-container>

    <!-- Cliente -->
    <ng-container matColumnDef="clientName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
      <td mat-cell *matCellDef="let row">
        {{ row.clientName || '-' }}
      </td>
    </ng-container>

    <!-- ID transacción -->
    <ng-container matColumnDef="transactionId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ID transacción</th>
      <td mat-cell *matCellDef="let row">
        {{ row.notificationId }}
      </td>
    </ng-container>

    <!-- Monto total -->
    <ng-container matColumnDef="totalAmount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto total</th>
      <td mat-cell *matCellDef="let row">
        {{ row.amount | currency: currency }}
      </td>
    </ng-container>

    <!-- Nº de asignaciones -->
    <ng-container matColumnDef="assignmentsCount">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nº de asignaciones</th>
      <td mat-cell *matCellDef="let row" style="text-align: center">
        {{ row.transactionDataList?.length || '-' }}
      </td>
    </ng-container>

    <!-- Estado -->
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
      <td mat-cell *matCellDef="let row">
        <span
          [ngClass]="{
            'status-pill': true,
            'status-pill--pending': row.conciliationStatus.value === 'PENDING',
            'status-pill--assigned': row.conciliationStatus.value === 'ASSIGNED',
            'status-pill--applied': row.conciliationStatus.value === 'APPLIED',
            'status-pill--conciliated': row.conciliationStatus.value === 'CONCILIATED',
            'status-pill--recieved': row.conciliationStatus.value === 'RECEIVED',
            'status-pill--error': row.conciliationStatus.value === 'INVALID'
          }"
        ></span>
        {{ getStatusLabel(row.conciliationStatus.value) }}
      </td>
    </ng-container>

    <!-- Acciones -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let row">
        <button
          *ngIf="row.conciliationStatus.value === 'APPLIED' && row.transactionDataList?.length > 0"
          mat-raised-button
          color="primary"
          class="action-btn"
          matTooltip="Ver detalle"
          (click)="$event.stopPropagation(); viewDetails(row)"
        >
          <fa-icon icon="eye"></fa-icon>
        </button>

        <!-- <button
          mat-raised-button
          color="primary"
          class="action-btn"
          matTooltip="Asignar"
          *ngIf="canAssign(row)"
          (click)="$event.stopPropagation(); viewDetails(row)"
        >
          <fa-icon icon="exchange-alt"></fa-icon>
        </button> -->
      </td>
    </ng-container>

    <!-- Header y filas -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns" (click)="onRowClick(row)" style="cursor: pointer"></tr>

    <!-- Sin datos -->
    <tr class="mat-row noContentTable" *matNoDataRow>
      <td class="mat-cell" [attr.colspan]="displayedColumns.length">
        <div class="empty-state">
          <fa-icon [icon]="filesvg" size="3x"></fa-icon>
          <p>No hay transacciones para mostrar.</p>
        </div>
      </td>
    </tr>
  </table>

  <!-- Paginador -->
  <mat-paginator
    [length]="totalItems"
    [pageSize]="pageSize"
    [pageIndex]="pageIndex"
    [pageSizeOptions]="[5, 10, 25, 50]"
    showFirstLastButtons
    (page)="onPageChange($event)"
  >
    ></mat-paginator
  >

  <mifosx-custom-dialog
    [open]="showDialogTransactions"
    [heading]="'Detalle de transacción'"
    color="primary"
    (confirm)="closeDetailedRow()"
    (dismiss)="closeDetailedRow()"
    (closed)="closeDetailedRow()"
    [hideCancelButton]="true"
    [confirmText]="'Submit'"
    [disableConfirm]="false"
  >
    <main>
      <section class="headerTransactionDetail">
        <p>Monto de la trasnferencia:</p>
        <p>
          {{ detailedRow?.amount | currency: currency }}
        </p>
        <div class="loadingBar">
          <div
            [ngStyle]="{
              width: detailedRow ? getConciliationProgress(detailedRow) + '%' : '0%'
            }"
          ></div>
        </div>
      </section>
      <section class="tableDetailContainer">
        <section class="tableDetailContainer">
          <table mat-table [dataSource]="detailDataSource" class="assignment-table">
            <!-- Asignación -->
            <ng-container matColumnDef="assignment">
              <th mat-header-cell *matHeaderCellDef>Asignación</th>
              <td mat-cell *matCellDef="let row; let i = index">Asignación {{ i + 1 }}</td>
            </ng-container>

            <!-- Proyecto -->
            <ng-container matColumnDef="project">
              <th mat-header-cell *matHeaderCellDef>Proyecto</th>
              <td mat-cell *matCellDef="let row">
                {{ row.projectName }}
              </td>
            </ng-container>

            <!-- Monto -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef>Monto</th>
              <td mat-cell *matCellDef="let row">
                {{ row.amount | currency: currency }}
              </td>
            </ng-container>

            <!-- ID de pago -->
            <ng-container matColumnDef="paymentId">
              <th mat-header-cell *matHeaderCellDef>ID de pago</th>
              <td mat-cell *matCellDef="let row">
                {{ row.transactionId }}
              </td>
            </ng-container>

            <!-- Ver detalle de pago -->
            <ng-container matColumnDef="view">
              <th mat-header-cell *matHeaderCellDef>Ver detalle de pago</th>
              <td mat-cell *matCellDef="let row">
                <button
                  mat-raised-button
                  color="primary"
                  class="action-btn"
                  matTooltip="Ver detalle de pago"
                  (click)="$event.stopPropagation(); onViewPaymentDetail(row)"
                >
                  <fa-icon icon="eye"></fa-icon>
                </button>
              </td>
            </ng-container>

            <!-- Header y filas -->
            <tr mat-header-row *matHeaderRowDef="detailDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: detailDisplayedColumns"></tr>
          </table>
        </section>
      </section>
    </main>
  </mifosx-custom-dialog>
</main>
